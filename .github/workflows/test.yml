

name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests-and-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8

      # - name: Run flake8
      #   run: |
      #     cd backend
      #     flake8 .

      - name: Run unit tests (exclude integration)
        run: |
          cd backend
          pytest -m "not integration"

  integration-tests:
    needs: tests-and-lint
    runs-on: ubuntu-latest
    # integration tests רק ב-Pull Request
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend test dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 1️⃣ בונים image של ה-backend בלבד (עם Dockerfile.backend)
      - name: Build backend Docker image for integration tests
        run: |
          docker build -f Dockerfile.backend -t currency-backend-test:${{ github.sha }} .

      # 2️⃣ מרימים קונטיינר לבדיקה על פורט 8080 במכונה → 5000 בקונטיינר
      - name: Run backend container for integration tests
        run: |
          docker run -d --name currency-backend-test -p 8080:5000 currency-backend-test:${{ github.sha }}

      # אופציונלי: לחכות כמה שניות שהשרת יעלה
      - name: Wait for backend to be ready
        run: |
          for i in {1..10}; do
            if curl -sSf http://localhost:8080/health > /dev/null; then
              echo "Backend is up!";
              exit 0
            fi
            echo "Waiting for backend..."
            sleep 2
          done
          echo "Backend did not become ready in time"
          exit 1

      # 3️⃣ מריצים את ה-integration tests (שפונים ל-http://localhost:8080)
      - name: Run integration tests
        run: |
          cd backend
          pytest -m integration

      # 4️⃣ מנקים את הקונטיינר
      - name: Stop and remove container
        if: always()
        run: |
          docker stop currency-backend-test || true
          docker rm currency-backend-test || true

  build-and-push:
    needs: tests-and-lint   # צריך רק שה-unit tests וה-lint יעברו
    runs-on: ubuntu-latest
    # רק על push ל-main
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    env:
      BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/currency-backend
      FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/currency-frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1️⃣ בונים backend image מ-Dockerfile.backend
      - name: Build backend Docker image
        run: |
          docker build -f Dockerfile.backend -t $BACKEND_IMAGE:${{ github.sha }} -t $BACKEND_IMAGE:latest .

      # 2️⃣ בונים frontend image מ-Dockerfile.frontend
      - name: Build frontend Docker image
        run: |
          docker build -f Dockerfile.frontend -t $FRONTEND_IMAGE:${{ github.sha }} -t $FRONTEND_IMAGE:latest .

      # 3️⃣ לוגין ל-Docker Hub
      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 4️⃣ Push של שני ה-images (גם tag לפי SHA וגם latest)
      - name: Push Docker images
        run: |
          docker push $BACKEND_IMAGE:${{ github.sha }}
          docker push $BACKEND_IMAGE:latest
          docker push $FRONTEND_IMAGE:${{ github.sha }}
          docker push $FRONTEND_IMAGE:latest





# name: CI/CD

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# jobs:
#   tests-and-lint:
#     runs-on: ubuntu-latest

#     if: github.event_name == 'pull_request'

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install backend dependencies
#         run: |
#           cd backend
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install flake8

#       - name: Run flake8
#         run: |
#           cd backend
#           flake8 .

#       - name: Run unit tests (exclude integration)
#         run: |
#           cd backend
#           pytest -m "not integration"

#   integration-tests:
#     needs: tests-and-lint
#     runs-on: ubuntu-latest
#     if: github.event_name == 'pull_request'

#     steps:
#       - name: Checkout code
#       # מורידים את הקוד
#         uses: actions/checkout@v4

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install backend test dependencies
#         run: |
#           cd backend
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       # 1. בונים image לבדיקה (לא דוחפים אותו, רק לוקאלי ל־CI)
#       - name: Build Docker image for integration tests
#         run: |
#           docker build -t currency-app-test:${{ github.sha }} .

#       # 2. מריצים את הקונטיינר ברקע על פורט 8080
#       - name: Run container for integration tests
#         run: |
#           docker run -d --name currency-app-test -p 8080:8080 currency-app-test:${{ github.sha }}

#       # 3. מריצים את ה-integration tests (test_integration.py)
#       - name: Run integration tests
#         run: |
#           cd backend
#           pytest -m integration

#       # 4. עוצרים ומנקים את הקונטיינר (לא חובה, אבל יפה)
#       - name: Stop and remove container
#         if: always()
#         run: |
#           docker stop currency-app-test || true
#           docker rm currency-app-test || true

#   build-and-push:
#     needs: [tests-and-lint, integration-tests]
#     runs-on: ubuntu-latest
#     # רק על push ל-main
#     if: github.ref == 'refs/heads/main' && github.event_name == 'push'

#     env:
#       IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/currency-app

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 1. בונים שוב image (הפעם עם השם של Docker Hub)
#       - name: Build Docker image
#         run: |
#           docker build -t $IMAGE_NAME:${{ github.sha }} -t $IMAGE_NAME:latest .

#       # 2. לוגין ל-Docker Hub
#       - name: Login to Docker Hub
#         run: |
#           echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

#       # 3. דחיפה ל-Docker Hub
#       - name: Push Docker image
#         run: |
#           docker push $IMAGE_NAME:${{ github.sha }}
#           docker push $IMAGE_NAME:latest





# # coverage run -m pytest
# # coverage html







